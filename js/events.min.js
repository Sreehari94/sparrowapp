angular.module("app.events",[]).controller("EventCtrl",["$scope","$http","$q","$stateParams","$state",function(a,b,c,d,e){console.log("Inside Events Ctrl"),console.log("stateParams: ",d),a.eventData={},a.jsonId={},window.scrollTo(0,0);var f=function(a){var d=c.defer();return b.get("assets/feedback.json").then(function(b){var c=b.data.body;console.log(b.data.body),console.log("Feedback Data: ",c);for(var e=0;e<c.feedback.length;e++)a.treasureHuntId==c.feedback[e].treasureHuntId?(a.feedback=c.feedback[e],console.log("feedbackData of current th:",a.feedback),d.resolve(a)):d.reject(a)},function(b){console.log("Error: ",b),d.reject(a)}),d.promise},g=function(a){var d=c.defer();return b.get("assets/thadd.json").then(function(b){console.log("Additional data response: ",b.data.body,a);for(var c=b.data.body,e=0;e<c.treasureHunts.length;e++)a.treasureHuntId==c.treasureHunts[e].treasureHuntId?(a.rate=c.treasureHunts[e].rate,null!=c.treasureHunts[e].treasureHuntDetails?a.treasureHuntDetails=c.treasureHunts[e].treasureHuntDetails:a.treasureHuntDetails=a.treasureHuntDescription,null!=c.treasureHunts[e].treasureHuntWeather&&(a.treasureHuntWeather=c.treasureHunts[e].treasureHuntWeather),null!=c.treasureHunts[e].treasureHuntHistory&&(a.treasureHuntHistory=c.treasureHunts[e].treasureHuntHistory),null!=c.treasureHunts[e].treasureHuntTravel&&(a.treasureHuntTravel=c.treasureHunts[e].treasureHuntTravel),null!=c.treasureHunts[e].treasureHuntFAQ&&(a.treasureHuntFAQ=c.treasureHunts[e].treasureHuntFAQ),null!=c.treasureHunts[e].treasureHuntThings?a.treasureHuntThings=c.treasureHunts[e].treasureHuntThings:a.treasureHuntThings=null,null!=c.treasureHunts[e].howtoPlayInstructions?a.howtoPlayInstructions=c.treasureHunts[e].howtoPlayInstructions:a.howtoPlayInstructions=null,null!=c.treasureHunts[e].aggregateRatings?a.aggregateRatings=c.treasureHunts[e].aggregateRatings:a.aggregateRatings={reviewCount:"0",ratingValue:"0"},null!=c.treasureHunts[e].thRank?a.thRank=c.treasureHunts[e].thRank:a.thRank=-1,a.galleryImages=c.treasureHunts[e].galleryImages,a.eventTimings=c.treasureHunts[e].eventTimings,a.eventDate=c.treasureHunts[e].eventDate,a.treasureHuntPrice=c.treasureHunts[e].treasureHuntPrice,a.eventId=c.treasureHunts[e].eventId,null!=c.treasureHunts[e].treasureHuntIcons&&(a.treasureHuntIcons=c.treasureHunts[e].treasureHuntIcons),d.resolve(a)):(console.log("Add additional details else part:",a),null==a.treasureHuntDetails||void 0==a.treasureHuntDetails?(a.thRank=-1,a.treasureHuntDetails=a.treasureHuntDescription,a.aggregateRatings={reviewCount:"0",ratingValue:"0"},d.reject(a)):d.reject(a))},function(b){console.log("Error: ",b),console.log("Nothing found"),d.reject(a)}),d.promise},h=function(b){for(var c=null,d=0;d<a.thData.treasureHunts.length;d++)a.thData.treasureHunts[d].thShortName.toLowerCase()!=b.toLowerCase()&&a.thData.treasureHunts[d].treasureHuntId!=b||(c=a.thData.treasureHunts[d]);return c},i=function(){var d=c.defer(),e={header:{clientId:"SPARROWZ_WEBSITE",apiVersion:apiVersion},body:{}};console.log("form data to get treasureHunts: ",e);var f={method:"POST",url:URL+"/services/guest/getTreasureHunts",headers:{"Content-Type":"application/json"},data:e};return b(f).then(function(b){a.thData=b.data.body;for(var c=0;c<a.thData.treasureHunts.length;c++)a.thData.treasureHunts[c].thShortName||(a.thData.treasureHunts[c].thShortName=a.generateThShortName(a.thData.treasureHunts[c].treasureHuntName));console.log(b.data.body),console.log("TH Data: ",a.thData),d.resolve(a.thData)},function(c){console.log("Error: ",c),a.setErrorMessage(),b.get("assets/thlist_all.json").then(function(b){a.thData=b.data.body;for(var c=0;c<a.thData.treasureHunts.length;c++)a.thData.treasureHunts[c].thShortName||(a.thData.treasureHunts[c].thShortName=a.generateThShortName(a.thData.treasureHunts[c].treasureHuntName));console.log(b.data.body),console.log("TH Data: ",a.thData),d.resolve(a.thData)},function(a){console.log("Error: ",a),d.reject(a)})}),d.promise},j=function(b){var d=c.defer();if(a.thData.treasureHunts){var e=h(b);e?(console.log("TH Specific data: ",e),d.resolve(e)):(console.log("Not able to proceed with specificData",e),d.reject())}else i().then(function(a){console.log("fetched data: ",a);var c=h(b);c?(console.log("TH Specific data: ",c),d.resolve(c)):d.reject()},function(a){console.log("Nothing found. 404"),d.reject(a)});return d.promise},k=function(){return console.log("State Params: ",d.thIdentifier),d.thIdentifier},l=function(b,c){var d={coords:{latitude:b,longitude:c}};a.getGeoCoderData(d).then(function(b){console.log("geoCoderData:",b);for(var c=0,d=0;d<b.address_components.length;d++)"locality"==b.address_components[d].types[0]&&(c=d,console.log("index found at: ",d));var e=b.address_components[c].long_name;a.eventData.locationInfo={address:b.formatted_address,placeName:e},n()},function(a){console.log("Not able to get location Info.")})},m=function(){if("object"==typeof google&&"object"==typeof google.maps){var b={lat:parseFloat(a.eventData.geoLocationDetails.latitude),lng:parseFloat(a.eventData.geoLocationDetails.longitude)},c=new google.maps.Map(document.getElementById("map"),{zoom:16,center:b});c.setOptions({scrollwheel:!1});new google.maps.Marker({position:b,map:c,title:a.eventData.treasureHuntName})}else console.log("Google api not defined")};a.ticketModal=function(a){if(window.screen.width<800)return void(window.location="https://ticketing.eventshigh.com/checkout3.jsp?eid="+a);var b=Math.random().toString(36).substring(7),c=Math.random().toString(36).substring(7),d=document.createElement("div");d.setAttribute("style","position: fixed; z-index: 1100; top: 0; left: 0; bottom: 0; right: 0; background-color: rgba(0,0,0,0.5);"),d.innerHTML="<div style='position: absolute; top: 50%; left: 50%; transform: translateY(-50%) translateX(-50%);'>  <h1 style='color:white;'>Loading ...</h1></div>";var e=void 0!==window.pageYOffset?window.pageYOffset:(document.documentElement||document.body.parentNode||document.body).scrollTop;e+=50;var f=document.createElement("div");f.setAttribute("style","position: absolute; z-index: 1200; top: "+e+"px; left: 0; width: 100%;"),f.innerHTML="<div style='margin:0 auto; width: 80%; max-width: 800px; background: white; box-shadow: 0 5px 15px rgba(0,0,0,.5); border-radius: 6px; border: 1px solid rgba(0,0,0,.2); outline: 0; background-clip: padding-box;'>  <iframe id='"+b+"' style='width: 100%; border: 0px;' src='https://ticketing.eventshigh.com/checkout3.jsp?eid="+a+"'>Your browser does not support iframe. Still living in an old age browser?</iframe>  <a id='"+c+"' href='#' style='float: right; color: black; font-size: 34px; font-weight: bold; margin-left:75%; top:8px; margin-right: 12px; position:absolute; border-bottom'>&times;</a></div>",f.style.display="none",window.document.body.insertBefore(f,window.document.body.firstChild),window.document.body.insertBefore(d,window.document.body.firstChild),window.addEventListener("message",function(a){if("https://ticketing.eventshigh.com"===a.origin&&0===a.data.indexOf("height:")){var c=document.getElementById(b);c&&(c.height="",c.height=a.data.substring(7)+"px")}},!1),document.getElementById(b).onload=function(){d.innerHTML="",f.style.display="block"};var g=function(a){return d.outerHTML="",f.outerHTML="",a.stopPropagation(),!1};document.getElementById(c).onclick=g,f.onclick=g,document.onkeydown=function(a){a=a||window.event;var b=!1;(b="key"in a?"Escape"==a.key||"Esc"==a.key:27==a.keyCode)&&g(a)}},a.triggerBookingModal=function(b){a.ticketModal(b),getTicket()};var n=function(){var b=new Date,c=b.toISOString();a.jsonId={"@context":"http://schema.org","@type":"Event",name:a.eventData.treasureHuntName,url:"http://www.sparrowzapp.com/"+a.selectedCity.cityCode+"/"+a.eventData.thShortName,image:a.eventData.treasureHuntImgUrl[0],startDate:c,aggregateRating:{"@type":"AggregateRating",ratingValue:a.eventData.aggregateRatings.ratingValue,reviewCount:a.eventData.aggregateRatings.reviewCount},location:{"@type":"Place",geo:{"@type":"GeoCoordinates",latitude:a.eventData.geoLocationDetails.latitude,longitude:a.eventData.geoLocationDetails.longitude},address:a.eventData.locationInfo.address,name:a.eventData.locationInfo.placeName}}},o=function(b){console.log("Setting tags");var c=b.treasureHuntName;c+=" - Play treasure hunts, quests, walks, tours - all using your mobile device",c="BLR"==a.selectedCity.cityCode?c+" - in "+a.selectedCity.cityName+" / Bangalore - ":c+" - in "+a.selectedCity.cityName+" - ",document.title=c,l(a.eventData.geoLocationDetails.latitude,a.eventData.geoLocationDetails.longitude),a.setMetaDescription(a.eventData.treasureHuntDetails)};!function(){a.setCityChangeEventListener(null);var b=k();console.log("Treasure hunt id: ",b),b?j(b).then(function(b){console.log("requestedTHData:",b),g(b).then(function(b){console.log("enrichedTHData:",b),f(b).then(function(b){a.eventData=b,o(a.eventData),console.log("enrichedTHDataWithFeedback:",b),m(),setTimeout(function(){$(".carousel").carousel({interval:4e3})},1e3)},function(b){a.eventData=b,o(a.eventData),console.log("thDataWithoutFeedback:",b),m(),setTimeout(function(){$(".carousel").carousel({interval:4e3})},1e3)})},function(b){f(b).then(function(b){a.eventData=b,o(a.eventData),console.log("THDataWithFeedback:",b),m(),setTimeout(function(){$(".carousel").carousel({interval:4e3})},1e3)},function(b){a.eventData=b,o(a.eventData),console.log("thDataWithoutFeedback:",b),m(),setTimeout(function(){$(".carousel").carousel({interval:4e3})},1e3)})})},function(a){console.log("Unable to fetch TH:",a),e.go("app.ERR404")}):e.go("app.home",{cityCode:"BLR"})}()}]);